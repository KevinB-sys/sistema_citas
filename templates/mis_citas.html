{% extends "base.html" %} {% block title %}Mis Citas - Sistema de Citas
Médicas{% endblock %} {% block content %}
<div class="container py-5 mt-5">
    {# Added mt-5 for spacing below the fixed navbar #}
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 text-center mb-4">Mis Citas Programadas</h1>
        </div>
    </div>

    <div class="card p-4 shadow-lg">
        <div class="card-body">
            <h4 class="card-title mb-4">
                <i class="fas fa-calendar-check me-2"></i>Detalle de Citas
            </h4>
            <div class="table-responsive">
                {# Makes table scrollable on small screens #}
                <table class="table table-hover table-striped">
                    {# Bootstrap table classes #}
                    <thead>
                        <tr>
                            <th>Médico</th>
                            <th>Fecha y Hora</th>
                            <th>Motivo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="citas-body">
                        <tr>
                            <td colspan="5" class="text-center">
                                Cargando citas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="mensaje" class="mt-3 text-center"></div>
            {# For displaying general messages #}
        </div>
    </div>

    <div class="text-center mt-5">
        <a
            href="{{ url_for('dashboard') }}"
            class="btn btn-secondary btn-lg me-3"
        >
            <i class="fas fa-arrow-left me-2"></i>Volver a mi área
        </a>
        <a
            href="{{ url_for('buscar_medicos') }}"
            class="btn btn-primary btn-lg"
        >
            <i class="fas fa-plus-circle me-2"></i>Agendar Nueva Cita
        </a>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    const mensajeDiv = document.getElementById("mensaje"); // Get the message div

    async function cancelarCita(citaId) {
        //if (!confirm("¿Estás seguro de que deseas cancelar esta cita? Esta acción no se puede deshacer.")) {
        //    return;
        //}

        try {
            const response = await fetch(`/cancelar-cita/${citaId}`, {
                // Ensure this URL matches your backend route
                method: "POST",
                headers: { "Content-Type": "application/json" },
            });

            const result = await response.json();

            if (response.ok) {
                mensajeDiv.className = "alert alert-success";
                mensajeDiv.textContent = result.message;
                cargarCitas(); // Reload appointments after successful cancellation
            } else {
                mensajeDiv.className = "alert alert-danger";
                mensajeDiv.textContent =
                    result.error ||
                    "Error al cancelar la cita. Por favor, inténtalo de nuevo.";
            }
        } catch (error) {
            console.error("Error al cancelar cita:", error);
            mensajeDiv.className = "alert alert-danger";
            mensajeDiv.textContent =
                "Error de conexión con el servidor al intentar cancelar la cita.";
        }
    }

    async function cargarCitas() {
        try {
            const response = await fetch("/mis-citas-json", {
                // Ensure this URL matches your backend route
                headers: { Accept: "application/json" },
            });
            if (!response.ok) {
                // Check if it's a 404 or other client error for more specific messages
                if (response.status === 404) {
                    throw new Error("La ruta de las citas no fue encontrada.");
                }
                throw new Error(
                    `Error ${response.status}: ${response.statusText}`
                );
            }
            const data = await response.json();

            const tbody = document.getElementById("citas-body");
            tbody.innerHTML = ""; // Clear existing rows

            if (data.citas.length === 0) {
                tbody.innerHTML =
                    '<tr><td colspan="5" class="text-center text-muted py-3">No tienes citas programadas.</td></tr>';
                return;
            }

            const now = new Date();

            data.citas.forEach((cita) => {
                const tr = document.createElement("tr");
                let estadoBadgeClass = "";
                let canCancel = false;
                const citaFechaHora = new Date(cita.fecha_hora);

                // Determine badge class and cancelability based on state and future date
                if (cita.estado === "programada") {
                    if (citaFechaHora > now) {
                        estadoBadgeClass = "bg-primary"; // Future appointment
                        canCancel = true;
                    } else {
                        estadoBadgeClass = "bg-info"; // Past scheduled, but not yet 'completada'
                    }
                } else if (cita.estado === "confirmada") {
                    estadoBadgeClass = "bg-success";
                    if (citaFechaHora > now) {
                        canCancel = true;
                    }
                } else if (cita.estado === "cancelada") {
                    estadoBadgeClass = "bg-danger";
                } else if (cita.estado === "completada") {
                    estadoBadgeClass = "bg-secondary";
                } else {
                    estadoBadgeClass = "bg-warning text-dark"; // Default or unknown status
                }

                // Format date and time
                const options = {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                };
                const formattedDateTime = citaFechaHora.toLocaleDateString(
                    "es-ES",
                    options
                );

                tr.innerHTML = `
                    <td>${cita.medico_nombre}</td>
                    <td>${formattedDateTime}</td>
                    <td>${
                        cita.motivo ||
                        '<span class="text-muted">Sin motivo</span>'
                    }</td>
                    <td><span class="badge ${estadoBadgeClass}">${
                    cita.estado.charAt(0).toUpperCase() + cita.estado.slice(1)
                }</span></td>
                    <td>
                        ${
                            canCancel
                                ? `<button class="btn btn-sm btn-danger" onclick="cancelarCita(${cita.id})">
                                <i class="fas fa-times-circle me-1"></i>Cancelar
                              </button>`
                                : '<span class="text-muted">-</span>'
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error("Error al cargar las citas:", error);
            mensajeDiv.className = "alert alert-danger";
            mensajeDiv.textContent =
                "Error al cargar tus citas: " + error.message;
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        cargarCitas();
    });
</script>
{% endblock %}

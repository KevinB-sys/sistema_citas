{% extends "base.html" %} {% block title %}Mis Citas - Sistema de Citas
Médicas{% endblock %} {% block content %}
<div class="container py-5 mt-5">
    {# Added mt-5 for spacing below the fixed navbar #}
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 text-center mb-4">Mis Citas Programadas</h1>
        </div>
    </div>

    <div class="card p-4 shadow-lg">
        <div class="card-body">
            <h4 class="card-title mb-4">
                <i class="fas fa-calendar-check me-2"></i>Detalle de Citas
            </h4>
            <div class="table-responsive">
                {# Makes table scrollable on small screens #}
                <table class="table table-hover table-striped">
                    {# Bootstrap table classes #}
                    <thead>
                        <tr>
                            <th>Médico</th>
                            <th>Fecha y Hora</th>
                            <th>Motivo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="citas-body">
                        <tr>
                            <td colspan="5" class="text-center">
                                Cargando citas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="mensaje" class="mt-3 text-center"></div>
            {# For displaying general messages #}
        </div>
    </div>

    <div class="text-center mt-5">
        <a
            href="{{ url_for('dashboard') }}"
            class="btn btn-secondary btn-lg me-3"
        >
            <i class="fas fa-arrow-left me-2"></i>Volver a mi área
        </a>
        <a
            href="{{ url_for('buscar_medicos') }}"
            class="btn btn-primary btn-lg"
        >
            <i class="fas fa-plus-circle me-2"></i>Agendar Nueva Cita
        </a>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    const mensajeDiv = document.getElementById("mensaje"); // Get the message div

    async function cancelarCita(citaId) {
        //if (!confirm("¿Estás seguro de que deseas cancelar esta cita? Esta acción no se puede deshacer.")) {
        //    return;
        //}

        try {
            const response = await fetch(`/cancelar-cita/${citaId}`, {
                // Ensure this URL matches your backend route
                method: "POST",
                headers: { "Content-Type": "application/json" },
            });

            const result = await response.json();

            if (response.ok) {
                mensajeDiv.className = "alert alert-success";
                mensajeDiv.textContent = result.message;
                cargarCitas(); // Reload appointments after successful cancellation
            } else {
                mensajeDiv.className = "alert alert-danger";
                mensajeDiv.textContent =
                    result.error ||
                    "Error al cancelar la cita. Por favor, inténtalo de nuevo.";
            }
        } catch (error) {
            console.error("Error al cancelar cita:", error);
            mensajeDiv.className = "alert alert-danger";
            mensajeDiv.textContent =
                "Error de conexión con el servidor al intentar cancelar la cita.";
        }
    }

    async function cargarCitas() {
        const tbody = document.getElementById("citas-body");
        const mensajeDiv = document.getElementById("mensaje");

        try {
            // Mostrar estado de carga
            tbody.innerHTML =
                '<tr><td colspan="5" class="text-center">Cargando citas...</td></tr>';

            console.log("Iniciando carga de citas...");
            const response = await fetch("/mis-citas-json");
            console.log("Respuesta recibida:", response.status);

            const data = await response.json();
            console.log("Datos recibidos:", data);

            // Limpiar mensaje anterior
            mensajeDiv.innerHTML = "";

            if (!response.ok) {
                throw new Error(data.error || "Error al cargar las citas");
            }

            tbody.innerHTML = "";

            if (!data.citas || data.citas.length === 0) {
                tbody.innerHTML =
                    '<tr><td colspan="5" class="text-center">No tienes citas programadas</td></tr>';
                return;
            }

            data.citas.forEach((cita) => {
                try {
                    console.log("Procesando cita:", cita);
                    const tr = document.createElement("tr");

                    // Formatear la fecha de manera segura
                    let fechaFormateada;
                    try {
                        fechaFormateada = new Date(
                            cita.fecha_hora
                        ).toLocaleString("es-ES", {
                            year: "numeric",
                            month: "2-digit",
                            day: "2-digit",
                            hour: "2-digit",
                            minute: "2-digit",
                        });
                    } catch (e) {
                        console.error("Error al formatear fecha:", e);
                        fechaFormateada =
                            cita.fecha_hora || "Fecha no disponible";
                    }

                    // Crear badge para el estado
                    let estadoBadgeClass = "";
                    switch (cita.estado) {
                        case "programada":
                            estadoBadgeClass = "bg-primary";
                            break;
                        case "completada":
                            estadoBadgeClass = "bg-success";
                            break;
                        case "cancelada":
                            estadoBadgeClass = "bg-danger";
                            break;
                        default:
                            estadoBadgeClass = "bg-secondary";
                    }

                    tr.innerHTML = `
                        <td>${cita.medico_nombre || "Médico no disponible"}</td>
                        <td>${fechaFormateada}</td>
                        <td>${
                            cita.motivo || "<em>Sin motivo especificado</em>"
                        }</td>
                        <td><span class="badge ${estadoBadgeClass}">${
                        cita.estado || "desconocido"
                    }</span></td>
                        <td>
                            ${
                                cita.estado === "programada"
                                    ? `<button class="btn btn-sm btn-danger" onclick="cancelarCita(${cita.id})">
                                        <i class="fas fa-times-circle"></i> Cancelar
                                       </button>`
                                    : "-"
                            }
                        </td>
                    `;
                    tbody.appendChild(tr);
                } catch (e) {
                    console.error("Error procesando cita:", e, cita);
                }
            });
        } catch (error) {
            console.error("Error al cargar citas:", error);
            mensajeDiv.innerHTML = `
                <div class="alert alert-danger">
                    Error al cargar las citas: ${error.message}
                </div>
            `;
            tbody.innerHTML =
                '<tr><td colspan="5" class="text-center text-danger">Error al cargar las citas</td></tr>';
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        console.log("Página cargada, iniciando carga de citas...");
        cargarCitas();
    });
</script>
{% endblock %}
